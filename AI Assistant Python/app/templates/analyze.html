{% extends "base.html" %}

{% block title %}Analyze Incident - AI Duty Officer Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex align-items-center mb-4">
            <h2 class="fw-bold mb-0">
                <i class="fas fa-search text-primary me-2"></i>
                Incident Analysis
            </h2>
        </div>
        
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Describe the Incident
                </h5>
            </div>
            <div class="card-body">
                <!-- Input Validation Error Alert -->
                {% if error %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Input Validation Failed:</strong> {{ error }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                
                <!-- Helpful Examples After Error -->
                <div class="alert alert-info" role="alert">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-lightbulb me-2"></i>
                        Valid Incident Description Examples:
                    </h6>
                    <ul class="mb-1">
                        <li><strong>Technical Issue:</strong> "Container CMAU123456 showing duplicate entries in PORTNET system causing discharge delays"</li>
                        <li><strong>System Error:</strong> "EDI message processing failure, getting ERROR status on all incoming vessel manifests"</li>
                        <li><strong>Equipment Problem:</strong> "Terminal 3 crane malfunction, operations halted, getting hydraulic pressure warnings"</li>
                    </ul>
                </div>
                {% endif %}
                
                <form method="post" action="/analyze" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="incidentDescription" class="form-label fw-bold">
                            Incident Description <span class="text-danger">*</span>
                        </label>
                        <textarea 
                            class="form-control" 
                            id="incidentDescription" 
                            name="incident_description"
                            rows="4" 
                            placeholder="Provide a detailed description of the maritime operations incident..."
                            required>{% if preloaded_description %}{{ preloaded_description }}{% elif description %}{{ description }}{% endif %}</textarea>
                        <div class="form-text">
                            <i class="fas fa-lightbulb text-warning me-1"></i>
                            Include system names, error messages, container numbers, vessel details, or any relevant identifiers
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="incidentImages" class="form-label fw-bold">
                            <i class="fas fa-camera me-1"></i>
                            Incident Images <span class="text-muted">(Optional)</span>
                        </label>
                        <input 
                            class="form-control" 
                            type="file" 
                            id="incidentImages" 
                            name="incident_images"
                            accept="image/*"
                            multiple>
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-primary" id="openCameraBtn">
                                <i class="fas fa-video me-1"></i>
                                Take Photo with Camera
                            </button>
                        </div>
                        <div class="form-text">
                            <i class="fas fa-info-circle text-info me-1"></i>
                            Upload photos or take pictures directly with your camera for AI visual analysis. Supported formats: JPG, PNG, GIF, WebP
                        </div>
                        <div id="imagePreview" class="mt-2 row g-2"></div>
                    </div>
                    
                    <!-- Log File Upload Section -->
                    <div class="mb-3">
                        <label for="logFiles" class="form-label fw-bold">
                            <i class="fas fa-file-alt me-1"></i>
                            System Log Files <span class="text-muted">(Optional)</span>
                        </label>
                        <input 
                            class="form-control" 
                            type="file" 
                            id="logFiles" 
                            name="log_files"
                            accept=".log,.txt,.csv,.json,.xml"
                            multiple>
                        <div class="form-text">
                            <i class="fas fa-info-circle text-info me-1"></i>
                            Upload system logs, error logs, or diagnostic files for detailed AI analysis. Supported formats: .log, .txt, .csv, .json, .xml
                        </div>
                        <div id="logPreview" class="mt-2"></div>
                    </div>

                    <div class="mb-3">
                        <label for="incidentSource" class="form-label fw-bold">Source</label>
                        <select class="form-select" id="incidentSource" name="incident_source">
                            <option value="Manual" selected>Manual Entry</option>
                            <option value="Email">Email</option>
                            <option value="SMS">SMS</option>
                            <option value="Call">Phone Call</option>
                            <option value="System">System Alert</option>
                            <option value="Log Analysis">Log File Analysis</option>
                        </select>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn">
                            <i class="fas fa-brain me-2"></i>
                            <span class="btn-text">Analyze Incident</span>
                            <div class="spinner-border spinner-border-sm ms-2" role="status" style="display: none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if test_cases %}
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-vial me-2"></i>
                    Sample Test Cases
                    <small class="text-muted">(Click to analyze)</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    {% for case in test_cases %}
                    <div class="col-lg-6">
                        <div class="card incident-card priority-{{ case.priority|lower }}" 
                             onclick="loadTestCase('{{ case.description|e }}')">
                            <div class="card-body">
                                <div class="d-flex align-items-start">
                                    <div class="me-3">
                                        <i class="{{ case.icon }} fa-lg text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="card-title fw-bold mb-1">{{ case.title }}</h6>
                                        <p class="card-text small text-muted mb-2">{{ case.description }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="badge bg-secondary">{{ case.category }}</span>
                                            <div>
                                                <span class="badge bg-info me-1">{{ case.source }}</span>
                                                <span class="badge 
                                                    {% if case.priority == 'Critical' %}bg-danger
                                                    {% elif case.priority == 'High' %}bg-warning
                                                    {% elif case.priority == 'Medium' %}bg-primary
                                                    {% else %}bg-success{% endif %}">
                                                    {{ case.priority }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">
                    <i class="fas fa-camera me-2"></i>
                    Take Incident Photo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="cameraContainer" style="display: none;">
                    <video id="cameraVideo" autoplay muted playsinline style="max-width: 100%; max-height: 400px; border-radius: 8px;"></video>
                    <canvas id="photoCanvas" style="display: none;"></canvas>
                </div>
                <div id="cameraError" class="alert alert-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage">Camera access is required to take photos.</span>
                </div>
                <div id="cameraLoading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading camera...</span>
                    </div>
                    <p class="mt-2 text-muted">Requesting camera access...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="capturePhotoBtn" style="display: none;">
                    <i class="fas fa-camera me-1"></i>
                    Capture Photo
                </button>
                <button type="button" class="btn btn-primary" id="retakePhotoBtn" style="display: none;">
                    <i class="fas fa-redo me-1"></i>
                    Take Another
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="invalidInputDialog" tabindex="-1" aria-labelledby="invalidInputDialogLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="invalidInputDialogLabel"><i class="fas fa-exclamation-triangle text-warning"></i> Invalid Input</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="invalidInputText">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadTestCase(description) {
    document.getElementById('incidentDescription').value = description;
    document.getElementById('incidentDescription').focus();
    
    // Scroll to form
    document.querySelector('.card').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
}

// Auto-resize textarea
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('incidentDescription');
    
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
    
    // --- START of the fix: Show invalid input modal ---
    const urlParams = new URLSearchParams(window.location.search);
    const error = urlParams.get('error');
    if (error) {
        const modal = new bootstrap.Modal(document.getElementById('invalidInputDialog'));
        document.getElementById('invalidInputText').innerText = error.replace(/\+/g, ' ');
        modal.show();
    }
    // --- END of the fix ---
});

// Image preview functionality
document.getElementById('incidentImages').addEventListener('change', function(e) {
    const files = e.target.files;
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (files.length > 0) {
        Array.from(files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-4 col-6';
                    
                    col.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" style="height: 120px; object-fit: cover;" alt="Preview ${index + 1}">
                            <div class="card-body p-2">
                                <small class="text-muted">${file.name}</small>
                                <br>
                                <small class="text-info">${(file.size / 1024).toFixed(1)} KB</small>
                            </div>
                        </div>
                    `;
                    
                    preview.appendChild(col);
                };
                reader.readAsDataURL(file);
            }
        });
    }
});

// Camera functionality
let currentStream = null;
let capturedPhotos = [];

document.getElementById('openCameraBtn').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();
    openCamera();
});

async function openCamera() {
    const video = document.getElementById('cameraVideo');
    const container = document.getElementById('cameraContainer');
    const loading = document.getElementById('cameraLoading');
    const error = document.getElementById('cameraError');
    const captureBtn = document.getElementById('capturePhotoBtn');
    
    try {
        // Reset UI
        container.style.display = 'none';
        error.style.display = 'none';
        loading.style.display = 'block';
        captureBtn.style.display = 'none';
        
        // Request camera access
        currentStream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                facingMode: 'environment' // Try to use back camera on mobile
            } 
        });
        
        video.srcObject = currentStream;
        
        video.onloadedmetadata = function() {
            loading.style.display = 'none';
            container.style.display = 'block';
            captureBtn.style.display = 'inline-block';
        };
        
    } catch (err) {
        console.error('Camera access error:', err);
        loading.style.display = 'none';
        error.style.display = 'block';
        
        let errorMsg = 'Camera access denied or not available.';
        if (err.name === 'NotAllowedError') {
            errorMsg = 'Camera permission denied. Please allow camera access and try again.';
        } else if (err.name === 'NotFoundError') {
            errorMsg = 'No camera found on this device.';
        } else if (err.name === 'NotSupportedError') {
            errorMsg = 'Camera not supported on this browser.';
        }
        
        document.getElementById('errorMessage').textContent = errorMsg;
    }
}

document.getElementById('capturePhotoBtn').addEventListener('click', function() {
    capturePhoto();
});

document.getElementById('retakePhotoBtn').addEventListener('click', function() {
    openCamera();
});

function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('photoCanvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size to video size
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert to blob
    canvas.toBlob(function(blob) {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `camera-capture-${timestamp}.jpg`;
        
        // Create file object
        const file = new File([blob], filename, { type: 'image/jpeg' });
        
        // Add to captured photos
        capturedPhotos.push(file);
        
        // Add to file input
        addCapturedPhotoToInput(file);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
        modal.hide();
        
        // Stop camera
        stopCamera();
        
    }, 'image/jpeg', 0.8);
}

function addCapturedPhotoToInput(file) {
    // Create a new FileList with existing files plus captured photo
    const input = document.getElementById('incidentImages');
    const dt = new DataTransfer();
    
    // Add existing files
    for (let i = 0; i < input.files.length; i++) {
        dt.items.add(input.files[i]);
    }
    
    // Add captured photo
    dt.items.add(file);
    
    // Update input
    input.files = dt.files;
    
    // Trigger change event to update preview
    input.dispatchEvent(new Event('change', { bubbles: true }));
}

function stopCamera() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
}

// Clean up camera when modal is hidden
document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function() {
    stopCamera();
});

// Log File Preview Functionality
document.getElementById('logFiles').addEventListener('change', function(e) {
    const files = e.target.files;
    const preview = document.getElementById('logPreview');
    preview.innerHTML = '';

    if (files.length > 0) {
        const container = document.createElement('div');
        container.className = 'row g-2 mt-2';
        
        Array.from(files).forEach((file, index) => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-body p-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-file-alt text-info me-2"></i>
                        <div class="flex-grow-1">
                            <div class="fw-bold small">${file.name}</div>
                            <div class="text-muted small">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="previewLogFile(${index})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            `;
            
            col.appendChild(card);
            container.appendChild(col);
        });
        
        preview.appendChild(container);
    }
});

function previewLogFile(index) {
    const files = document.getElementById('logFiles').files;
    const file = files[index];
    
    if (file.size > 1024 * 1024) { // 1MB limit for preview
        alert('File too large for preview. It will still be analyzed.');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        const lines = content.split('\n').slice(0, 20); // Show first 20 lines
        
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Log File Preview: ${file.name}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 12px;">${lines.join('\n')}</pre>
                        ${content.split('\n').length > 20 ? '<p class="text-muted mt-2"><i class="fas fa-info-circle"></i> Showing first 20 lines. Full file will be analyzed.</p>' : ''}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        modal.addEventListener('hidden.bs.modal', function() {
            modal.remove();
        });
    };
    
    reader.readAsText(file);
}

// Loading state for analyze button
document.querySelector('form').addEventListener('submit', function(e) {
    const analyzeBtn = document.getElementById('analyzeBtn');
    const spinner = analyzeBtn.querySelector('.spinner-border');
    const btnText = analyzeBtn.querySelector('.btn-text');
    
    // Show loading state
    analyzeBtn.disabled = true;
    spinner.style.display = 'inline-block';
    btnText.textContent = 'Analyzing...';
});
</script>
{% endblock %}